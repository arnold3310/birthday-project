<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç›¡æ˜Ÿæ²³ V9 (å„ªé›…æ…¢é€Ÿç‰ˆ)</title>
    <style>
        /* =========================================
           1. å…¨å±€è¨­å®š & åŸºç¤æ¨£å¼
           ========================================= */
        body { 
            margin: 0; background: #050505; overflow: hidden; 
            font-family: 'Microsoft JhengHei', sans-serif; color: white;
            user-select: none; cursor: default;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
        }

        /* =========================================
           2. èƒŒæ™¯å±¤ (å®‡å®™ã€æ˜Ÿé›²ã€ç²’å­)
           ========================================= */
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #020111 0%, #191621 100%);
            z-index: 0; overflow: hidden;
        }

        .nebula-cloud {
            position: absolute; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(62, 28, 168, 0.2), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 222, 0.15), transparent 30%),
                radial-gradient(circle at 50% 50%, rgba(0, 240, 255, 0.1), transparent 50%);
            filter: blur(20px);
            animation: nebula-move 20s ease-in-out infinite alternate;
        }

        .bg-star {
            position: absolute; background: #fff; border-radius: 50%; opacity: 0.8;
            animation: twinkle var(--duration) ease-in-out infinite;
        }
        .bg-star.small { width: 1px; height: 1px; opacity: 0.5; }
        .bg-star.medium { width: 2px; height: 2px; opacity: 0.7; box-shadow: 0 0 2px #fff; }
        .bg-star.large { width: 3px; height: 3px; box-shadow: 0 0 5px #fff, 0 0 10px #00f0ff; }

        /* å®‡å®™å®¹å™¨ (é‹é¡å±¤) */
        #universe {
            position: absolute; top: 0; left: 0; width: 100%;
            transform: translateY(0); 
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10; will-change: transform;
        }
        
        /* ğŸ”¥ å…‰é€Ÿé£›è¡Œæ¨¡å¼ç‰¹æ•ˆ (é€Ÿåº¦èª¿æ•´) */
        body.warp-mode .bg-star {
            transition: transform 0.5s, opacity 0.5s; /* ç¨å¾®æ…¢ä¸€é»çš„æ‹‰ä¼¸ */
            transform: scaleY(30) scaleX(0.1); opacity: 0.6;
            box-shadow: 0 0 10px #00f0ff; filter: blur(1px);
        }
        body.warp-mode #universe {
            /* ğŸ”¥ é€™è£¡æ”¹æˆäº† 3.0s (åŸæœ¬æ˜¯ 1.2s)ï¼Œè®“é‹é¡éå¸¸å¹³ç©© */
            transition: transform 3.0s cubic-bezier(0.45, 0, 0.1, 1) !important;
            filter: brightness(1.3);
        }

        /* ç•«å¸ƒ */
        #particle-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; filter: drop-shadow(0 0 10px rgba(232, 214, 181, 0.4));
        }
        #line-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }

        /* =========================================
           3. UI å±¤ (Intro, Confirm, Item, Boss)
           ========================================= */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: #000; overflow: hidden; transition: opacity 0.5s;
        }

        /* å·è»¸ç¢ºèªè¦–çª— */
        #scroll-confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 45000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #scroll-confirm-modal.active .confirm-box { transform: scale(1); }
        .confirm-box {
            width: 300px; padding: 30px;
            background: rgba(16, 24, 35, 0.95);
            border: 2px solid #00f0ff; box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
            border-radius: 15px; text-align: center;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .confirm-title { font-size: 1.5rem; color: #ffd700; font-weight: bold; margin-bottom: 15px; text-shadow: 0 0 10px #ffd700; }
        .confirm-text { font-size: 1.1rem; color: #fff; margin-bottom: 30px; line-height: 1.6; }
        .confirm-btn-group { display: flex; justify-content: space-around; gap: 15px; }
        .confirm-btn { padding: 10px 25px; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-yes { background: #00f0ff; color: #000; box-shadow: 0 0 10px #00f0ff; }
        .btn-yes:hover { transform: scale(1.1); background: #fff; }
        .btn-no { background: #555; color: #aaa; border: 1px solid #777; }
        .btn-no:hover { background: #666; color: #fff; }

        /* Sç´šé“å…·éå ´ */
        #item-get-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 60; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            perspective: 1500px;
        }
        .sunburst {
            position: absolute; width: 200vmax; height: 200vmax;
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.15) 0deg 10deg, transparent 10deg 20deg);
            animation: rotateSun 20s linear infinite; z-index: 0; pointer-events: none;
        }
        .legendary-card-container {
            position: relative; width: 320px; height: 480px; z-index: 10;
            animation: cardEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.2) forwards; opacity: 0;
        }
        .legendary-card {
            width: 100%; height: 100%; position: relative; border-radius: 20px; overflow: hidden;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5), 0 0 100px rgba(255, 215, 0, 0.3);
            transform-style: preserve-3d;
        }
        .card-frame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 8px solid transparent;
            background: linear-gradient(to bottom right, #FFD700, #B8860B); z-index: 5;
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        .card-frame::after {
            content: ''; position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px;
            border-radius: 24px; border: 8px solid #FFD700;
            box-shadow: inset 0 0 20px #B8860B, 0 0 20px #FFD700; pointer-events: none; z-index: 5;
        }
        .card-bg {
            position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px;
            background: linear-gradient(to bottom, #1a0f30, #3a1c71, #d76d77);
            border-radius: 16px; z-index: 1; overflow: hidden;
        }
        .card-bg::before {
            content: ''; position: absolute; width: 200%; height: 200%;
            background-image: radial-gradient(#fff 1px, transparent 1px), radial-gradient(#FFD700 2px, transparent 2px);
            background-size: 50px 50px, 100px 100px;
            background-position: 0 0, 25px 25px;
            animation: particleMove 10s linear infinite; opacity: 0.5;
        }
        .card-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 30px 20px; box-sizing: border-box; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        .rarity-text {
            display: block; font-size: 4rem; font-weight: 900; font-style: italic;
            background: linear-gradient(to right, #FFD700, #fff, #FFD700);
            -webkit-background-clip: text; color: transparent; filter: drop-shadow(0 0 10px #FFD700);
        }
        .type-text { display: block; font-size: 1.2rem; color: #FFD700; letter-spacing: 5px; margin-top: -10px; font-weight: bold; }
        .card-icon { font-size: 10rem; filter: drop-shadow(0 0 30px #FFD700) hue-rotate(-15deg); animation: iconFloat 3s ease-in-out infinite alternate; }
        .item-name-card {
            font-size: 2.5rem; font-weight: 900; background: linear-gradient(to bottom, #fff, #FFD700);
            -webkit-background-clip: text; color: transparent; padding: 10px 20px; width: 100%; text-align: center;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); 
        }
        .card-shockwave {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; animation: shockwave 0.8s ease-out 0.3s forwards; z-index: 0;
        }
        .tap-continue {
            margin-top: 50px; font-size: 1.2rem; color: #aaa;
            animation: fadeIn 1s 2s forwards, pulse 1s infinite; opacity: 0; z-index: 2;
        }

        /* Boss å±¤ */
        #boss-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s;
        }
        .warning-sign {
            color: #ff3333; font-size: 2.5rem; font-weight: 900;
            border: 4px solid #ff3333; padding: 10px 40px; margin-bottom: 50px;
            text-shadow: 0 0 20px #ff0000; box-shadow: 0 0 30px #ff0000, inset 0 0 20px #ff0000;
            animation: warnFlash 0.5s infinite alternate; letter-spacing: 5px;
        }
        #boss-avatar {
            font-size: 8rem; cursor: crosshair; filter: drop-shadow(0 0 30px #a0f);
            transition: transform 0.1s; user-select: none;
        }
        #boss-avatar:active { transform: scale(0.9); }
        .boss-hit { animation: shakeBoss 0.3s; filter: brightness(5) drop-shadow(0 0 50px red) !important; }
        .boss-scary {
            position: fixed; font-size: 12rem !important;
            filter: drop-shadow(0 0 30px #ff0000) contrast(1.5) sepia(1) hue-rotate(-50deg);
            animation: scaryShake 0.1s infinite;
            transition: top 0.6s ease-in-out, left 0.6s ease-in-out, transform 0.2s;
            z-index: 20005;
        }
        #boss-hp-container {
            width: 300px; height: 20px; border: 2px solid #fff; margin-top: 30px;
            border-radius: 10px; overflow: hidden; background: #333;
        }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff8800); transition: width 0.2s; }
        .damage-text {
            position: absolute; color: #fff; font-weight: bold; font-size: 1.5rem;
            pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 0 0 5px red;
        }
        .boss-hint { color: #aaa; margin-top: 10px; font-size: 0.9rem; letter-spacing: 2px; animation: pulse 1s infinite; }
        .taunt-text {
            position: absolute; color: #ff00ff; font-weight: bold; font-size: 1.5rem;
            pointer-events: none; text-shadow: 0 0 10px #000; animation: popUp 0.8s forwards; white-space: nowrap; z-index: 20010;
        }

        /* å¯¶ç®± */
        #start-btn-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; z-index: 4000;
        }
        #chest-wrapper {
            position: relative; width: 220px; height: 180px; cursor: pointer; z-index: 50; display: none;
            animation: chestDrop 1s cubic-bezier(0.5, -0.5, 0.2, 1.5); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }
        .chest-base, .chest-lid {
            position: absolute; width: 100%; background: linear-gradient(135deg, #5c2a0d 0%, #8b4513 50%, #5c2a0d 100%);
            border: 4px solid #3e1e09; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
        }
        .chest-base { bottom: 0; height: 65%; border-radius: 0 0 20px 20px; }
        .chest-base::before {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 20px;
            background: #FFD700; border-radius: 0 0 16px 16px; border-top: 2px solid #DAA520;
        }
        .chest-lid {
            bottom: 63%; height: 45%; border-radius: 20px 20px 0 0; transform-origin: bottom center;
            transition: transform 0.6s cubic-bezier(0.4, 2, 0.5, 1); z-index: 2;
            background: linear-gradient(to bottom, #a0522d, #8b4513);
        }
        .chest-strap {
            position: absolute; width: 24px; height: 100%; top: 0;
            background: linear-gradient(to right, #B8860B, #FFD700, #B8860B);
            border-left: 1px solid #fff; border-right: 1px solid #000; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .chest-strap.left { left: 40px; } .chest-strap.right { right: 40px; }
        .chest-strap::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#8B4513 15%, transparent 16%); background-size: 24px 24px;
        }
        .chest-lock {
            position: absolute; top: 100%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #FFD700, #DAA520);
            border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 15px #FFD700, 0 5px 10px rgba(0,0,0,0.5);
            z-index: 5; transition: all 0.3s;
        }
        .chest-lock::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 18px; background: #3e1e09; border-radius: 20px 20px 0 0;
        }
        #chest-wrapper.opened .chest-lid { transform: rotateX(120deg) translateY(-30px); }
        #chest-wrapper.opened .chest-lock { opacity: 0; transform: translate(-50%, -100px) scale(2); }
        .chest-godray {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            box-shadow: 0 0 100px 50px #fff; z-index: 10; opacity: 0;
        }
        #chest-wrapper.opened .chest-godray { animation: godRayFlash 1s ease-out forwards; }
        
        /* å·è»¸æŒ‰éˆ•èˆ‡å…§å®¹ */
        #scroll-content { display: none; flex-direction: column; align-items: center; }
        #scroll-icon { font-size: 8rem; margin-bottom: 30px; filter: drop-shadow(0 0 20px #ffd700); animation: floatScroll 3s ease-in-out infinite; }
        #start-btn {
            padding: 15px 40px; font-size: 1.5rem; letter-spacing: 3px; font-weight: bold;
            color: #e8d6b5; background: rgba(0, 0, 0, 0.6); border: 2px solid #e8d6b5; border-radius: 10px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px rgba(232, 214, 181, 0.2);
        }
        #start-btn:hover { background: #e8d6b5; color: #000; box-shadow: 0 0 50px #e8d6b5; transform: scale(1.05); }

        /* æ•‘æ´èˆ‡ç«æŸ´äºº */
        #help-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); border: 2px solid #00f0ff; box-shadow: 0 0 30px #00f0ff;
            padding: 30px; border-radius: 15px; text-align: center; z-index: 30000; display: none;
            flex-direction: column; gap: 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #help-modal h2 { margin: 0; color: #fff; font-size: 1.5rem; }
        #help-modal p { margin: 0; color: #aaa; }
        .help-btn-group { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .help-btn { padding: 10px 30px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; font-weight: bold; }
        
        #stickman-hero {
            position: fixed; bottom: 10%; left: -200px; width: 150px; height: 200px;
            z-index: 29000; pointer-events: none; transition: transform 0.2s;
        }
        .stick-head { width: 40px; height: 40px; border: 4px solid #fff; border-radius: 50%; position: absolute; top: 0; left: 55px; }
        .stick-body { width: 4px; height: 80px; background: #fff; position: absolute; top: 40px; left: 73px; }
        .stick-arm-l { width: 4px; height: 50px; background: #fff; position: absolute; top: 50px; left: 73px; transform-origin: top center; transform: rotate(30deg); }
        .stick-arm-r { width: 4px; height: 50px; background: #fff; position: absolute; top: 50px; left: 73px; transform-origin: top center; transform: rotate(-60deg); transition: transform 0.1s; }
        .stick-leg-l { width: 4px; height: 60px; background: #fff; position: absolute; top: 115px; left: 73px; transform-origin: top center; transform: rotate(20deg); }
        .stick-leg-r { width: 4px; height: 60px; background: #fff; position: absolute; top: 115px; left: 73px; transform-origin: top center; transform: rotate(-20deg); }
        .stick-sword { width: 6px; height: 120px; background: linear-gradient(to top, #00f0ff, #fff); position: absolute; top: 40px; left: -10px; box-shadow: 0 0 20px #00f0ff; transform-origin: bottom center; transform: rotate(-30deg); }
        .slash-fx {
            position: fixed; top: 50%; left: 50%; width: 120%; height: 5px; background: #fff;
            transform: translate(-50%, -50%) rotate(-15deg) scaleX(0); box-shadow: 0 0 50px 20px #00f0ff;
            z-index: 29500; opacity: 0; pointer-events: none;
        }
        #stickman-hero.attacking .stick-arm-r { transform: rotate(-160deg); }
        #stickman-hero.slashing .stick-arm-r { transform: rotate(45deg); transition: transform 0.05s ease-out; }

        /* =========================================
           4. æ ¸å¿ƒå±•ç¤ºå…ƒä»¶ (æ˜Ÿé»ã€ç…§ç‰‡ã€æ–‡å­—ã€æ§åˆ¶)
           ========================================= */
        .star-node {
            position: absolute; width: 40px; height: 40px; transform: translate(-50%, -50%);
            z-index: 20; display: flex; justify-content: center; align-items: center;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .star-core {
            position: absolute; width: 12px; height: 12px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(0, 240, 255, 0.6); z-index: 2;
            animation: starPulse 3s infinite ease-in-out;
        }
        .star-ring {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.15); border-top: 1px solid rgba(0, 240, 255, 0.8); border-bottom: 1px solid rgba(0, 240, 255, 0.3);
            box-shadow: 0 0 5px rgba(0, 240, 255, 0.2); z-index: 1; animation: starSpin 6s linear infinite;
        }
        .star-node.medium { z-index: 50; transform: translate(-50%, -50%) scale(2.5); }
        .star-node.medium .star-core { background: #ffd700; box-shadow: 0 0 15px #ffd700, 0 0 30px #ffaa00; }
        .star-node.medium .star-ring { border-top-color: #ffd700; border-bottom-color: rgba(255, 215, 0, 0.5); animation: starSpin 2s linear infinite; width: 36px; height: 36px; }
        .star-node.hidden { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }

        #photo-viewer {
            position: fixed; top: 0; left: 0; width: 40px; height: 40px; border-radius: 50%; 
            background-color: #fff; background-size: cover; background-position: center;
            transition: all 1.2s cubic-bezier(0.25, 0.8, 0.25, 1); transform-origin: center center;
            z-index: 900; opacity: 0; pointer-events: none; overflow: hidden;
        }
        #photo-viewer.center-stage {
            opacity: 1; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) scale(1) !important;
            width: 65vh !important; height: 65vh !important; max-width: 800px; max-height: 800px;
            border-radius: 24px; border: none;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 0 0 8px rgba(255, 255, 255, 0.1), inset 0 0 0 2px rgba(255, 255, 255, 0.5), 0 0 40px rgba(0, 240, 255, 0.3);
        }
        #photo-viewer.center-stage::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to bottom right, transparent 40%, rgba(255, 255, 255, 0.5) 50%, transparent 60%);
            transform: rotate(45deg); animation: holoScan 3s linear infinite; pointer-events: none; mix-blend-mode: overlay;
        }
        #photo-viewer.move-left {
            left: 28% !important; top: 50% !important; width: 55vh !important; height: 55vh !important; 
            transform: translate(-50%, -50%) perspective(1000px) rotateY(15deg) !important;
            box-shadow: -15px 15px 40px rgba(0, 0, 0, 0.6), 0 0 0 6px rgba(255, 255, 255, 0.15), inset 0 0 0 2px rgba(255, 255, 255, 0.6);
        }
        #photo-viewer.move-left::after { opacity: 0.2; }

        #message-card {
            position: fixed; top: 50%; right: 10%; transform: translateY(-50%) translateX(50px);
            width: 350px; max-width: 80vw; padding: 30px;
            background: rgba(16, 24, 35, 0.75); backdrop-filter: blur(15px);
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); border-left: 4px solid #00f0ff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); color: #eee;
            font-family: 'DFKai-SB', 'BiauKai', 'æ¨™æ¥·é«”', 'Microsoft JhengHei', sans-serif;
            font-weight: 500; letter-spacing: 2px; font-size: 1.3rem; line-height: 1.8;
            opacity: 0; pointer-events: none; transition: all 0.8s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 850;
        }
        #message-card::before {
            content: 'MEMORY_LOG'; position: absolute; top: -10px; right: 20px;
            font-size: 0.7rem; font-weight: bold; color: #00f0ff; background: #000;
            padding: 2px 8px; border: 1px solid rgba(0, 240, 255, 0.3); border-radius: 4px; letter-spacing: 2px;
        }
        #message-card.show { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateX(0); }
        .cursor { display: inline-block; width: 8px; height: 18px; background-color: #00f0ff; margin-left: 5px; vertical-align: middle; animation: cursorBlink 0.8s infinite; }

        #control-panel {
            position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 1s;
        }
        #control-panel.show { opacity: 1; pointer-events: auto; }
        .nav-btn {
            padding: 12px 40px; background: rgba(0, 0, 0, 0.5); border: 1px solid #fff; color: #fff;
            font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: 0.3s;
        }
        .nav-btn:hover { background: #fff; color: #000; transform: scale(1.05); }
        #progress-bar { position: fixed; top: 0; left: 0; height: 3px; width: 0%; background: linear-gradient(90deg, #00f0ff, #ff00de); z-index: 1000; transition: width 1.5s; }

        /* =========================================
           5. å‹•ç•«èˆ‡ç‰¹æ•ˆ Keyframes
           ========================================= */
        @keyframes floatScroll { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes textPulse { from { opacity: 0.6; } to { opacity: 1; text-shadow: 0 0 40px #ffd700; } }
        @keyframes flashOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes nebula-move { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes starPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.9); opacity: 0.8; } }
        @keyframes starSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes holoScan { 0% { transform: rotate(45deg) translateY(-100%); opacity: 0; } 50% { opacity: 1; } 100% { transform: rotate(45deg) translateY(100%); opacity: 0; } }
        @keyframes cursorBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes warnFlash { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0.5; transform: scale(0.98); } }
        @keyframes shakeBoss { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(-10px, 10px) rotate(-5deg); } 50% { transform: translate(10px, -10px) rotate(5deg); } 75% { transform: translate(-10px, -10px) rotate(-5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        @keyframes popUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 50% { transform: translateY(-40px) scale(1.2); opacity: 1; } 100% { transform: translateY(-80px) scale(1); opacity: 0; } }
        @keyframes scaryShake { 0% { transform: translate(2px, 2px) rotate(0deg); } 25% { transform: translate(-2px, -2px) rotate(-2deg); } 50% { transform: translate(-2px, 2px) rotate(2deg); } 75% { transform: translate(2px, -2px) rotate(-2deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes superSlash { 0% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(0); opacity: 1; } 30% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(1); opacity: 1; } 100% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(1); opacity: 0; } }
        @keyframes cardEntrance { 0% { opacity: 0; transform: scale(0.2) rotateY(180deg) translateY(100px); } 60% { opacity: 1; transform: scale(1.1) rotateY(-10deg); } 100% { opacity: 1; transform: scale(1) rotateY(0deg); } }
        @keyframes shockwave { to { width: 800px; height: 800px; box-shadow: 0 0 100px 50px rgba(255, 215, 0, 0); } }
        @keyframes iconFloat { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        @keyframes rotateSun { to { transform: rotate(360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes godRayFlash { 0% { opacity: 1; box-shadow: 0 0 50px 20px #fff; } 100% { opacity: 0; box-shadow: 0 0 500px 200px #FFD700; } }

        /* å·è»¸ç‡ƒç‡’å‹•ç•« (V6) */
        @keyframes burn-consume {
            0% { transform: translateY(0) scale(1); filter: brightness(1); opacity: 1; }
            10% { transform: translateY(-10px) scale(1.1); filter: brightness(1.5) sepia(1) hue-rotate(-30deg) drop-shadow(0 0 20px #ff4500); }
            25% { transform: translateY(-20px) scale(1.0) rotate(2deg); filter: brightness(2) sepia(1) saturate(5) hue-rotate(-40deg) drop-shadow(0 0 50px #ff0000); }
            50% { transform: translateY(-40px) scale(0.7) rotate(-2deg); filter: grayscale(0.8) brightness(0.6) sepia(1) drop-shadow(0 0 15px #8b0000); opacity: 0.9; }
            80% { transform: translateY(-60px) scale(0.3); filter: grayscale(1) brightness(0.2) blur(2px); opacity: 0.5; }
            100% { transform: translateY(-80px) scale(0); filter: grayscale(1) brightness(0) blur(10px); opacity: 0; }
        }
        .scroll-burn { animation: burn-consume 5s cubic-bezier(0.45, 0, 0.55, 1) forwards !important; z-index: 5000; position: relative; }
        .ember-particle {
            position: absolute; width: 3px; height: 3px; background: #ff4500; border-radius: 50%; pointer-events: none; z-index: 4999;
            box-shadow: 0 0 5px #ff0000; animation: ember-fly 2s linear forwards;
        }

        /* Glitch & Floating Effects */
        @keyframes glitch-anim {
            0% { transform: translate(-50%, -50%) scale(1) skew(0deg); box-shadow: 0 0 0 rgba(0,0,0,0); filter: hue-rotate(0deg); }
            20% { transform: translate(-55%, -50%) scale(1.02) skew(10deg); box-shadow: -5px 0 0 rgba(255,0,0,0.5), 5px 0 0 rgba(0,255,255,0.5); filter: hue-rotate(90deg) contrast(1.5); }
            40% { transform: translate(-45%, -50%) scale(0.98) skew(-5deg); box-shadow: 5px 0 0 rgba(255,0,0,0.5), -5px 0 0 rgba(0,255,255,0.5); filter: hue-rotate(-90deg); }
            60% { transform: translate(-50%, -52%) scale(1.05) skew(5deg); filter: invert(0.2); }
            100% { transform: translate(-50%, -50%) scale(1) skew(0deg); filter: none; }
        }
        .glitch-effect { animation: glitch-anim 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes float-breath { 0%, 100% { transform: translate(-50%, -50%) translateY(0px); } 50% { transform: translate(-50%, -50%) translateY(-10px); } }
        .floating-effect { animation: float-breath 4s ease-in-out infinite; }

        /* å…¶ä»–è¼”åŠ© Class */
        #status-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; color: #fff; text-shadow: 0 0 20px #ffd700;
            letter-spacing: 5px; display: none; z-index: 20; white-space: nowrap;
        }
        .status-pulse { animation: textPulse 1.5s infinite alternate; }
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; opacity: 0; pointer-events: none; }
        .flash-bang { animation: flashOut 2.5s ease-out forwards; }
        #start-btn-container { display: none; } /* åˆå§‹éš±è—ï¼Œç­‰ Boss æ­»æ‰ */
    </style>
</head>
<body>

    <audio id="bgm-boss" loop><source src="boss.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-win" loop><source src="win.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-countdown" loop><source src="countdown.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-galaxy" loop><source src="galaxy.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-typing" loop><source src="typing.mp3" type="audio/mpeg"></audio>
    <audio id="se-click"><source src="click.mp3" type="audio/mpeg"></audio>
    <audio id="se-slash"><source src="slash.mp3" type="audio/mpeg"></audio>
    <audio id="se-warp"><source src="warp.mp3" type="audio/mpeg"></audio>

    <div id="intro-layer">
        
        <div id="scroll-confirm-modal">
            <div class="confirm-box">
                <div class="confirm-title">ğŸ“œ ç³»çµ±æç¤º</div>
                <div class="confirm-text">æª¢æ¸¬åˆ°é«˜æ¿ƒåº¦å›æ†¶èƒ½é‡ã€‚<br>æ˜¯å¦ç«‹å³å•Ÿç”¨ã€Œå›æ†¶å·è»¸ã€ï¼Ÿ</div>
                <div class="confirm-btn-group">
                    <button class="confirm-btn btn-yes" onclick="confirmStart(true)">æ˜¯ (Yes)</button>
                    <button id="btn-no" class="confirm-btn btn-no" onclick="confirmStart(false)">å¦ (No)</button>
                </div>
            </div>
        </div>
        
        <canvas id="particle-canvas"></canvas>

        <div id="item-get-layer" onclick="finishItemGet()">
            <div class="sunburst"></div>
            <div class="legendary-card-container">
                <div class="card-shockwave"></div>
                <div class="legendary-card">
                    <div class="card-frame"></div>
                    <div class="card-bg"></div>
                    <div class="card-content">
                        <div class="card-header">
                            <span class="rarity-text">S-RANK</span>
                            <span class="type-text">å‚³èªªé“å…·</span>
                        </div>
                        <div class="card-icon">ğŸ“œ</div>
                        <div class="card-footer"><div class="item-name-card">å›æ†¶å·è»¸</div></div>
                    </div>
                </div>
            </div>
            <div class="tap-continue">- é»æ“Šä»»æ„è™•é ˜å– -</div>
        </div>

        <div id="boss-layer">
            <div class="warning-sign">âš ï¸ WARNING âš ï¸</div>
            <div style="font-size: 1.2rem; margin-bottom: 20px;">é«˜å¼·åº¦å›æ†¶é«”å‡ºç¾ï¼</div>
            <div id="boss-avatar" onclick="hitBoss(event)">ğŸ‘¾</div>
            <div id="boss-hp-container"><div id="boss-hp-bar"></div></div>
            <div class="boss-hint">>> é»æ“Šæ€ªç‰©é€²è¡Œæ”»æ“Š <<</div>
        </div>

        <div id="start-btn-container">
            <div id="chest-wrapper" onclick="openChest()">
                <div class="chest-lid">
                    <div class="chest-strap left"></div><div class="chest-strap right"></div><div class="chest-lock"></div>
                </div>
                <div class="chest-base">
                    <div class="chest-strap left"></div><div class="chest-strap right"></div>
                </div>
                <div class="chest-godray"></div>
            </div>

             <div id="scroll-content">
                <div id="scroll-icon">ğŸ“œ</div>
                <button id="start-btn" onclick="askToStart()">æ‹¾å–å›æ†¶å·è»¸</button>
            </div>
        </div>

        <div id="help-modal">
            <h2>âš ï¸ è‹¦æˆ°è­¦å‘Š âš ï¸</h2>
            <p id="help-text-1">Boss å¤ªå¼·äº†å—ï¼Ÿæ²’é—œä¿‚çš„</p>
            <p id="help-text-2">æ˜¯å¦å¬å–š <b>å¸¥å“¥é˜¿è«¾</b> é€²è¡Œæ”¯æ´ï¼Ÿ</p>
            <div class="help-btn-group">
                <button class="help-btn btn-yes" onclick="summonAuthor()">æ˜¯ï¼Œæ•‘æ•‘æˆ‘ï¼</button>
                <button class="help-btn btn-no" onclick="rejectHelp()">å¦ï¼Œæˆ‘è‡ªå·±ä¾†</button>
            </div>
        </div>

        <div id="stickman-hero">
            <div class="stick-head"></div><div class="stick-body"></div>
            <div class="stick-arm-l"></div><div class="stick-arm-r"><div class="stick-sword"></div></div>
            <div class="stick-leg-l"></div><div class="stick-leg-r"></div>
        </div>
        <div id="slash-layer" class="slash-fx"></div>

        <div id="status-message"></div>
    </div>
    
    <div id="flash-overlay"></div>
    <div id="progress-bar"></div>

    <div id="bg-layer"><div class="nebula-cloud"></div></div>
    <div id="universe">
        <canvas id="line-canvas"></canvas>
        <div id="stars-container"></div>
    </div>

    <div id="photo-viewer"></div>
    <div id="message-card"><div id="typewriter-text"></div></div>
    <div id="control-panel"><button id="next-btn" class="nav-btn" onclick="nextStep()"> å‡ºç™¼ ğŸš€ </button></div>

<script>
    // ==========================================
    // 1. å…¨å±€è®Šæ•¸èˆ‡è¨­å®š
    // ==========================================
    const photoData = [
        { text: "åŸæœ¬åªæ˜¯æƒ³ä¾†ä¸€å ´æ­²æœˆéœå¥½çš„ç™»å±±ä¹‹æ—…ï¼Œäº«å—ä¸€ä¸‹é¢¨æ™¯ï¼ŒçµæœåŠè·¯æ®ºå‡ºé€™å€‹è—è‰²ä¸æ˜ç”Ÿç‰©ï¼ğŸ˜‚è«‹å•æ‰‹è£¡é‚£æ ¹é¡è‰²è©­ç•°çš„ã€Œè—è‰²é¦™è•‰çš®ã€åˆ°åº•æ˜¯æƒ³æ€æ¨£å•¦ï¼Ÿä¸ç®¡æˆ‘å¾€å±±ä¸Šçˆ¬é‚„æ˜¯å¾€å±±ä¸‹è·‘ï¼Œå›é ­éƒ½èƒ½çœ‹åˆ°ä»–æ‹¿è‘—é¦™è•‰ã€é ‚è‘—é‚£å¼µè¬ä¹‹å‘†èŒçš„è‡‰ç·Šè¿½ä¸æ¨ã€‚é€™å¹´é ­çˆ¬å€‹å±±éƒ½è¦è¢«é¦™è•‰æ€ªå®¢è·Ÿè¹¤ï¼Œæˆ‘å¿ƒå¥½ç´¯...èª°å¿«ä¾†æŠŠé€™éš»é ˜èµ°ï¼ğŸ†˜ğŸŒ  ", src: "photo1.png" },
        { text: "æˆ‘çœŸçš„è¦è¢«å¦³çš„è§’è‰²çµ¦ç¬‘æ­»ï¼Œé€™å¼µç…§ç‰‡å¿…é ˆæ°¸ä¹…å°å­˜ï¼ğŸ“¸è«‹å•é€™ä½èœ‚é†«å¤§å…µï¼Œå¦³ç¾åœ¨æ˜¯åœ¨é€²è¡Œä»€éº¼æ·±å¥§çš„äººç”Ÿå“²å­¸æ€è€ƒå—ï¼Ÿåœ¨é€™ç¨®éš¨æ™‚æœƒè¢«ç‹™æ“Šçš„å®¤å…§ï¼Œå¦³ç«Ÿç„¶èƒ½éœ²å‡ºé€™ç¨®ã€Œçœ‹é€ä¸–ä¿—ã€ç”šè‡³æœ‰é»æƒ³ç¡ã€çš„è¿·é›¢çœ¼ç¥ã€‚", src: "photo2.png" }, 
        { text: "é›–ç„¶æˆ‘ä¹ŸçŸ¥é“é€™æ¢éš§é“æ˜¯å®‰å…¨çš„ï¼Œä¸ç”¨æ“”å¿ƒå¯¦é«”è¡å‡ºä¾†å’¬äººï¼Œä½†é€™ä¸ä»£è¡¨å¦³å¯ä»¥åœ¨é€™è£¡é–‹å€‹äººæ”å½±å±•æ¬¸ï¼ğŸ˜‚ å¦³çœ‹å¦³é‚£å€‹è‚¢é«”èªè¨€ï¼Œå®Œå…¨å°±æ˜¯ä¸€å‰¯ã€Œçµ‚æ–¼ä¾†åˆ°çŸ¥åæ‰“å¡æ™¯é»ã€çš„éŠå®¢æ¨£ã€‚", src: "photo3.png" },
        { text: "å¦³ä¸è¦çœ‹ç…§ç‰‡å°±èªªæˆ‘æ²’åšäº‹ï¼æˆ‘å¿ƒè£¡ä¹Ÿæ˜¯å¾ˆç´¯çš„å¥½å—ï¼ğŸ˜¤å¦³çœ‹ç•«é¢è£¡ï¼Œå¦³åœ¨å‰é¢å¥®åŠ›åˆ’èˆ¹ï¼Œæˆ‘åœ¨å¾Œé¢æ‹¿è‘—å·§å…‹åŠ›æ£’ï¼Œä¹çœ‹ä¹‹ä¸‹å¥½åƒæˆ‘æ˜¯è–ªæ°´å°å·ã€‚ä½†å¦³ä¸çŸ¥é“çš„æ˜¯ï¼Œçœ‹è‘—å¦³é‚£ç¨®ã€Œéš¨æ€§æµã€çš„åˆ’èˆ¹æ³•ï¼Œæˆ‘å¿ƒç†å£“åŠ›æœ‰å¤šå¤§ï¼", src: "photo4.png" },
        { text: "æˆ‘ç™¼èª“ï¼æˆ‘çœŸçš„åªæ˜¯æ€•ç¤¦å‘å¤ªå†·ï¼Œæƒ³å¹«å¦³ã€Œå–æš–ã€è€Œå·²ï¼ğŸ”¥å¦³çœ‹é€™å¼µç…§ç‰‡è£¡çš„ç«å…‰å¤šéº¼æº«é¦¨ã€å¤šéº¼è€€çœ¼ï¼ˆï¼Ÿï¼‰ã€‚é›–ç„¶é€™æ˜¯æˆ‘å€‘ç¬¬ä¸€æ¬¡ä¸€èµ·ç© Minecraftï¼Œé›–ç„¶æˆ‘æ‰‹è£¡æ‹¿è‘—æ‰“ç«æ©Ÿï¼Œé›–ç„¶å¦³æ•´å€‹äººéƒ½è®Šæˆäº†ä¸€åœ˜ç«çƒ...ä½†è¿™éƒ½æ˜¯ç‚ºäº†å±•ç¾æˆ‘å°éšŠå‹çš„ã€Œç†±æƒ…ã€å•Šï¼", src: "photo5.png" },
        { text: "å¦³é‚£å€‹ã€Œç¾©ç„¡åé¡§è·³é€²ç«æµ·ã€çš„æ±ºå¿ƒçœŸçš„å¾ˆæ„Ÿäººï¼Œä½†æˆ‘å€‘æ˜¯è¦éé—œå•Šå¤§å§Šï¼çœ‹è‘—å¦³ä¸€ç›´åœ¨é‡ç”Ÿé»å’Œå²©æ¼¿ä¹‹é–“æŠ˜è¿”è·‘ï¼Œæˆ‘çœŸçš„æ‡·ç–‘å¦³æ˜¯ä¸æ˜¯æƒ³æŠŠé€™å¼µåœ°åœ–çš„å²©æ¼¿å–ä¹¾ï¼ŸğŸ†˜ğŸ§±", src: "photo6.png" },
        { text: "æˆ‘å¼·çƒˆæ‡·ç–‘æˆ‘å€‘å…¥éŒ¯è¡Œäº†ï¼Œæˆ‘å€‘ä¸è©²ä¾†è§£è¬ï¼Œæˆ‘å€‘æ‡‰è©²å»é¦¬æˆ²åœ˜è¡¨æ¼”ç©ºä¸­é£›äººï¼ğŸª", src: "photo7.png" },
        { text: "æˆ‘åš´é‡æ‡·ç–‘é€™å°å¡è»Šæœ‰è‡ªå·±çš„æƒ³æ³•ï¼ğŸš›", src: "photo8.png" },
        { text: "é€™ä¹Ÿæ˜¯ä¸€å¼µç…§ç‰‡...", src: "photo9.png" },
        { text: "é€™æ˜¯ä¸€å¼µç…§ç‰‡...", src: "photo10.png" },
        { text: "é€™æ˜¯ä¸€å¼µç…§ç‰‡...", src: "photo11.png" },
        { text: "é€™æ˜¯ä¸€å¼µç…§ç‰‡...", src: "photo12.png" }
    ];

    const universe = document.getElementById('universe');
    const container = document.getElementById('stars-container');
    const canvas = document.getElementById('line-canvas');
    const ctx = canvas.getContext('2d');
    const progressBar = document.getElementById('progress-bar');
    const nextBtn = document.getElementById('next-btn');
    const photoViewer = document.getElementById('photo-viewer');
    const messageCard = document.getElementById('message-card');
    const typeText = document.getElementById('typewriter-text');
    const STAR_GAP = 800; 
    const SCREEN_H = window.innerHeight;
    let starPositions = [];
    let currentIndex = -1;
    let isAnimating = false;

    // Intro Canvas è®Šæ•¸
    let pCtx, pCanvas, pW, pH;
    let jupiterParticles = []; 
    let digitParticles = [];   
    let animationId;
    let pCount = 5; 
    let cachedDigitPoints = {}; 
    const premiumGoldColors = ['#FFD700', '#FDB931', '#FFFACD', '#BF953F', '#FFFFFF'];

    // ==========================================
    // 2. éŸ³æ•ˆç³»çµ±
    // ==========================================
    function switchMusic(playId) {
        const audios = ['bgm-boss', 'bgm-win', 'bgm-countdown', 'bgm-galaxy'];
        audios.forEach(id => {
            const audio = document.getElementById(id);
            if(audio) { audio.pause(); audio.currentTime = 0; }
        });
        if(playId) {
            const target = document.getElementById(playId);
            if(target) { target.volume = 0.5; target.play().catch(e => console.log("éŸ³æ•ˆç­‰å¾…äº’å‹•:", e)); }
        }
    }

    function initButtonSound() {
        const clickSound = document.getElementById('se-click');
        if (!clickSound) return;
        clickSound.volume = 0.6;
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                clickSound.currentTime = 0; clickSound.play().catch(() => {});
            });
        });
        ['#chest-wrapper', '#boss-avatar', '#item-get-layer'].forEach(selector => {
            const el = document.querySelector(selector);
            if(el) el.addEventListener('click', () => {
                clickSound.currentTime = 0; clickSound.play().catch(() => {});
            });
        });
    }
    initButtonSound();

    // ==========================================
    // 3. Intro å€’æ•¸ç²’å­å‹•ç•«
    // ==========================================
    function startCountdown() {
        switchMusic('bgm-countdown');
        document.getElementById('start-btn-container').style.display = 'none';
        const statusMsg = document.getElementById('status-message');
        const intro = document.getElementById('intro-layer');
        const flash = document.getElementById('flash-overlay');

        initCanvas(); createJupiter(); 
        statusMsg.innerText = "å›æ†¶å·è»¸å•Ÿå‹•ä¸­...";
        statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
        preCalculateDigits(); animate(); 

        setTimeout(() => {
            statusMsg.style.display = "none"; statusMsg.classList.remove('status-pulse');
            runCountdownSequence();
        }, 1500);

        async function runCountdownSequence() {
            while (pCount > 0) {
                useCachedParticles(pCount); await wait(1200);
                explodeParticles(); await wait(600); 
                pCount--;
            }
            statusMsg.innerText = "å›æ†¶å·è»¸å•Ÿå‹•å®Œæˆ";
            statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
            await wait(1000); cancelAnimationFrame(animationId);
            flash.classList.add('flash-bang'); intro.style.opacity = 0;
            switchMusic(null); await wait(500);
            intro.style.display = 'none'; 
            if(typeof initGalaxy === 'function') initGalaxy(); 
            const ctrl = document.getElementById('control-panel');
            if(ctrl) ctrl.classList.add('show');
        }
    }

    // Canvas è¼”åŠ©å‡½å¼ (Scan, Particles, Jupiter...)
    function preCalculateDigits() {
        for(let i = 1; i <= 5; i++) { cachedDigitPoints[i] = performScan(i); }
    }
    function performScan(text) {
        const points = []; const scale = 0.25; const sW = Math.floor(pW * scale); const sH = Math.floor(pH * scale);
        const tmpCanvas = document.createElement('canvas'); const tmpCtx = tmpCanvas.getContext('2d');
        tmpCanvas.width = sW; tmpCanvas.height = sH;
        const fontSize = Math.min(pW, pH) * 0.35 * scale; tmpCtx.font = `900 ${fontSize}px Arial Black`;
        tmpCtx.fillStyle = '#fff'; tmpCtx.textAlign = 'center'; tmpCtx.textBaseline = 'middle';
        tmpCtx.fillText(text, sW/2, sH/2);
        const imgData = tmpCtx.getImageData(0, 0, sW, sH).data; const gap = 2; 
        for(let y = 0; y < sH; y += gap) {
            for(let x = 0; x < sW; x += gap) {
                if(imgData[(y * sW + x) * 4 + 3] > 128) points.push({ x: x / scale, y: y / scale });
            }
        }
        return points;
    }
    function useCachedParticles(num) {
        const points = cachedDigitPoints[num] || []; digitParticles = []; 
        points.forEach(p => {
            const angle = Math.random() * Math.PI * 2; const dist = Math.max(pW, pH) * 0.8; 
            digitParticles.push({
                x: pW/2 + Math.cos(angle) * dist, y: pH/2 + Math.sin(angle) * dist, tx: p.x, ty: p.y,
                vx: 0, vy: 0, size: Math.random() * 3.5 + 1.5, color: premiumGoldColors[Math.floor(Math.random() * premiumGoldColors.length)],
                alpha: 1, isExploding: false, ease: Math.random() * 0.06 + 0.04 
            });
        });
    }
    function explodeParticles() {
        digitParticles.forEach(p => {
            p.isExploding = true; const angle = Math.random() * Math.PI * 2; const force = (Math.random() * 50 + 50) * (Math.min(pW, pH) / 1000); 
            p.vx = Math.cos(angle) * force; p.vy = Math.sin(angle) * force;
        });
    }
    function initCanvas() {
        pCanvas = document.getElementById('particle-canvas'); pCtx = pCanvas.getContext('2d');
        resize(); window.addEventListener('resize', resize);
    }
    function resize() { pW = pCanvas.width = window.innerWidth; pH = pCanvas.height = window.innerHeight; }
    function createJupiter() {
        jupiterParticles = [];
        const particleCount = 1800; const radius = Math.min(pW, pH) * 0.28; 
        for (let i = 0; i < particleCount; i++) {
            const theta = Math.random() * Math.PI * 2; const phi = Math.acos((Math.random() * 2) - 1); 
            const yRatio = Math.cos(phi); 
            let color = yRatio > 0.9 ? '#5e4e3e' : yRatio > 0.6 ? '#bf9b6b' : yRatio > 0.4 ? '#e8d6b5' : yRatio > 0.1 ? '#8c5636' : yRatio > -0.2 ? '#e8d6b5' : yRatio > -0.6 ? '#8c5636' : '#a38466';
            jupiterParticles.push({ type: 'planet', theta, phi, radius, color, size: Math.random() * 2 + 0.5, speed: 0.002 + Math.random() * 0.001 });
        }
        const ringCount = 800; const ringInner = radius * 1.3; const ringOuter = radius * 2.3; 
        for(let i = 0; i < ringCount; i++) {
            const dist = ringInner + Math.random() * (ringOuter - ringInner);
            const ringColor = Math.random() > 0.6 ? 'rgba(232, 214, 181, 0.7)' : 'rgba(255, 215, 0, 0.3)';
            jupiterParticles.push({ type: 'ring', angle: Math.random() * Math.PI * 2, distance: dist, color: ringColor, size: Math.random() * 1.5 + 0.5, speed: 0.001 + Math.random() * 0.002, tilt: 0.35 });
        }
    }
    function drawJupiter() {
        jupiterParticles.forEach(p => {
            if(p.type === 'planet') {
                p.theta += p.speed;
                const x3d = p.radius * Math.sin(p.phi) * Math.cos(p.theta); const y3d = p.radius * Math.cos(p.phi); const z3d = p.radius * Math.sin(p.phi) * Math.sin(p.theta);
                if(z3d > -p.radius * 0.8) { 
                    const scale = (z3d + p.radius * 2) / (p.radius * 2); 
                    pCtx.beginPath(); pCtx.arc(pW / 2 + x3d, pH / 2 + y3d, p.size * scale, 0, Math.PI * 2); pCtx.fillStyle = p.color; pCtx.fill();
                }
            } else {
                p.angle += p.speed;
                const y3d = p.distance * Math.sin(p.angle) * p.tilt;
                pCtx.beginPath(); pCtx.arc(pW / 2 + p.distance * Math.cos(p.angle), pH / 2 + y3d, p.size, 0, Math.PI * 2); pCtx.fillStyle = p.color; pCtx.fill();
            }
        });
    }
    function animate() {
        pCtx.fillStyle = '#000'; pCtx.fillRect(0, 0, pW, pH); drawJupiter(); 
        for (let i = 0; i < digitParticles.length; i++) {
            let p = digitParticles[i];
            if (p.isExploding) { p.x += p.vx; p.y += p.vy; p.vx *= 0.96; p.vy *= 0.96; p.alpha -= 0.015; p.size *= 0.97; } 
            else { p.x += (p.tx - p.x) * p.ease; p.y += (p.ty - p.y) * p.ease; }
            if (p.alpha > 0.05) {
                pCtx.beginPath(); pCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); pCtx.fillStyle = p.color; pCtx.globalAlpha = p.alpha; pCtx.fill(); pCtx.globalAlpha = 1; 
            }
        }
        animationId = requestAnimationFrame(animate);
    }

    // ==========================================
    // 4. Boss æˆ°é¬¥é‚è¼¯
    // ==========================================
    let bossPhase = 1, bossHP = 100, maxHP = 100, p2MaxHP = 300, clickTimer = null, isTeleporting = false, moveInterval = null, helpTimer = null, tauntInterval = null;
    const bossLayer = document.getElementById('boss-layer');
    const bossAvatar = document.getElementById('boss-avatar');
    const hpBar = document.getElementById('boss-hp-bar');
    const warningSign = document.querySelector('.warning-sign');
    const bossHint = document.querySelector('.boss-hint');
    const startBtnContainer = document.getElementById('start-btn-container');
    const helpModal = document.getElementById('help-modal');

    function initBossBattle() {
        bossPhase = 1; bossHP = 100; maxHP = 100;
        bossHint.innerText = ">> é»æ“Šæ€ªç‰©é€²è¡Œæ”»æ“Š <<"; bossAvatar.innerText = "ğŸ‘»"; bossAvatar.style.fontSize = "8rem";
        bossAvatar.classList.remove('boss-scary'); bossAvatar.style.position = 'static'; bossAvatar.style.opacity = 1;
        updateHPBar();
        if(moveInterval) clearInterval(moveInterval); if(tauntInterval) clearInterval(tauntInterval); if(helpTimer) clearTimeout(helpTimer);
        helpModal.style.display = 'none';
        switchMusic('bgm-boss');
    }
    initBossBattle();

    function hitBoss(e) {
        if(bossHP <= 0 && bossPhase === 2) return; if(isTeleporting) return;
        const x = e.clientX; const y = e.clientY;
        if (bossPhase === 1) handlePhase1Damage(x, y);
        else handlePhase2Logic(x, y);
    }

    function handlePhase2Logic(x, y) {
        if (clickTimer) {
            clearTimeout(clickTimer); clickTimer = null;
            const damage = Math.floor(Math.random() * 30) + 20; applyDamage(damage, x, y);
            bossHint.innerText = ">> æˆåŠŸé€£æ“Šï¼é€ æˆå‚·å®³ï¼ <<"; bossHint.style.color = "#ff3333";
            if(bossHP <= 0) bossDie();
        } else {
            bossAvatar.style.transform = "scale(2.1)"; setTimeout(() => bossAvatar.style.transform = "scale(2.0)", 100);
            clickTimer = setTimeout(() => { clickTimer = null; teleportBoss(); }, 280);
        }
    }

    function handlePhase1Damage(x, y) {
        if(bossHP === maxHP) {
            warningSign.innerText = "æ±‚é¥’æ¨¡å¼"; warningSign.style.color = "#ffff00"; warningSign.style.borderColor = "#ffff00"; bossHint.innerText = "Boss: å“å”·ï¼åˆ¥æ‰“è‡‰ï¼";
        } else {
            const begs = ["é¥’å‘½å•Šï¼", "æˆ‘éŒ¯äº†ï¼", "åˆ¥æ‰“äº†ï¼", "ç—›ç—›ç—›ï¼"];
            showTauntText(x, y, begs[Math.floor(Math.random() * begs.length)], '#fff');
        }
        const damage = Math.floor(Math.random() * 15) + 10; applyDamage(damage, x, y);
        if(bossHP <= 0) { bossHP = 0; transformToPhase2(); }
    }

    function transformToPhase2() {
        bossPhase = 2; bossHP = p2MaxHP; 
        warningSign.innerText = "BOSS æš´èµ°ä¸­"; warningSign.style.color = "#ff0000"; warningSign.style.borderColor = "#ff0000"; warningSign.style.animation = "warnFlash 0.1s infinite alternate"; 
        bossAvatar.innerText = "ğŸ‘¹"; bossAvatar.classList.add('boss-scary'); 
        bossHint.innerText = "âš ï¸ é–å®šç›®æ¨™ï¼šè«‹å¿«é€Ÿé€£é»å…©ä¸‹ï¼"; bossHint.style.color = "#00f0ff";
        showTauntText(window.innerWidth/2, window.innerHeight/2, "å¼å–”å–”å–”å–”ï¼ï¼ï¼", "#ff0000");
        updateHPBar(); startAutoMove();

        tauntInterval = setInterval(() => {
            if(isTeleporting) return;
            const rect = bossAvatar.getBoundingClientRect();
            const activeTaunts = ["æ‰“ä¸åˆ°ï½", "å¤ªæ…¢äº†ï¼", "å°±é€™ï¼Ÿ", "å¥½ç™¢å–”", "æ”¾æ£„å§ï¼"];
            showTauntText(rect.left + 50, rect.top, activeTaunts[Math.floor(Math.random() * activeTaunts.length)], '#00f0ff');
        }, 2000);

        helpTimer = setTimeout(() => { if(bossHP > 0) { document.getElementById('help-text-1').innerText = "Boss å¤ªå¼·äº†å—ï¼Ÿæ²’é—œä¿‚"; document.getElementById('help-text-2').innerText = "æ˜¯å¦å¬å–š å¸¥å“¥ä½œè€… é€²è¡Œæ”¯æ´ï¼Ÿ"; helpModal.style.display = 'flex'; } }, 15000);
    }

    function applyDamage(dmg, x, y) {
        bossHP -= dmg; if(bossHP < 0) bossHP = 0;
        updateHPBar(); bossAvatar.classList.remove('boss-hit'); void bossAvatar.offsetWidth; bossAvatar.classList.add('boss-hit');
        if(x && y) showDamageNumber(x, y, dmg);
    }
    function updateHPBar() { const currentMax = (bossPhase === 1) ? maxHP : p2MaxHP; hpBar.style.width = (bossHP / currentMax) * 100 + '%'; }
    function startAutoMove() {
        const rect = bossAvatar.getBoundingClientRect(); bossAvatar.style.position = 'fixed'; bossAvatar.style.left = rect.left + 'px'; bossAvatar.style.top = rect.top + 'px';
        moveInterval = setInterval(() => { if(!isTeleporting) moveBossRandomly(); }, 800);
    }
    function moveBossRandomly() {
        const padding = 150; bossAvatar.style.left = (Math.random() * (window.innerWidth - padding * 2) + padding) + 'px'; bossAvatar.style.top = (Math.random() * (window.innerHeight - padding * 2) + padding) + 'px';
    }
    function teleportBoss() {
        isTeleporting = true;
        const taunts = ["æŠ“ä¸åˆ°ï¼", "å¤ªæ…¢äº†ï¼", "ç¬ç§»ï¼", "å¼±çˆ†äº†"]; const rect = bossAvatar.getBoundingClientRect();
        showTauntText(rect.left, rect.top, taunts[Math.floor(Math.random() * taunts.length)], '#00f0ff');
        bossAvatar.style.opacity = 0; 
        setTimeout(() => { moveBossRandomly(); bossAvatar.style.opacity = 1; isTeleporting = false; }, 200);
    }
    function bossDie() {
        switchMusic('bgm-win');
        if(moveInterval) clearInterval(moveInterval); if(tauntInterval) clearInterval(tauntInterval); if(helpTimer) clearTimeout(helpTimer);
        bossAvatar.style.transition = "all 0.5s"; bossAvatar.style.transform = "scale(0) rotate(180deg)"; bossAvatar.style.opacity = 0;
        warningSign.innerText = "VICTORY!"; warningSign.style.borderColor = "#ffd700"; warningSign.style.color = "#ffd700"; bossHint.style.display = 'none';
        setTimeout(() => {
            bossLayer.style.opacity = 0;
            setTimeout(() => { bossLayer.style.display = 'none'; startBtnContainer.style.display = 'flex'; document.getElementById('chest-wrapper').style.display = 'block'; document.getElementById('scroll-content').style.display = 'none'; }, 1000);
        }, 800);
    }
    function showDamageNumber(x, y, dmg) {
        const el = document.createElement('div'); el.className = 'damage-text'; el.innerText = '-' + dmg;
        el.style.left = (x + (Math.random() - 0.5) * 40) + 'px'; el.style.top = (y - 30) + 'px';
        bossLayer.appendChild(el); setTimeout(() => el.remove(), 800);
    }
    function showTauntText(x, y, text, color) {
        const el = document.createElement('div'); el.className = 'taunt-text'; el.innerText = text; el.style.color = color;
        el.style.left = x + 'px'; el.style.top = (y - 80) + 'px'; bossLayer.appendChild(el); setTimeout(() => el.remove(), 800);
    }

    // æ•‘æ´ç³»çµ±é‚è¼¯
    function rejectHelp() {
        helpModal.style.display = 'none'; if(helpTimer) clearTimeout(helpTimer);
        helpTimer = setTimeout(() => { if(bossHP > 0 && bossPhase === 2) { document.getElementById('help-text-1').innerText = "çœŸçš„ä¸éœ€è¦å¹«å¿™å—ï¼Ÿ"; document.getElementById('help-text-2').innerText = "å¸¥å“¥é˜¿è«¾éš¨æ™‚æº–å‚™å‡ºæ‰‹å–”ï¼"; helpModal.style.display = 'flex'; } }, 5000);
    }
    function summonAuthor() {
        helpModal.style.display = 'none'; if(moveInterval) clearInterval(moveInterval); if(tauntInterval) clearInterval(tauntInterval);
        const hero = document.getElementById('stickman-hero'); const slash = document.getElementById('slash-layer'); const bossRect = bossAvatar.getBoundingClientRect();
        hero.style.left = (bossRect.left - 100) + 'px'; hero.style.top = (bossRect.top + 50) + 'px'; hero.style.transform = "scale(1)";
        setTimeout(() => { hero.classList.add('attacking'); showTauntText(bossRect.left, bossRect.top - 100, "å¸¥å“¥ä½œè€…ï¼šå€Ÿéï¼", "#fff"); }, 500);
        setTimeout(() => {
            hero.classList.add('slashing');
            const slashSound = document.getElementById('se-slash'); if(slashSound) { slashSound.currentTime = 0; slashSound.play().catch(console.error); }
            slash.style.left = (bossRect.left + 100) + 'px'; slash.style.top = (bossRect.top + 100) + 'px'; slash.style.animation = "superSlash 0.3s forwards";
            setTimeout(() => { applyDamage(99999, bossRect.left, bossRect.top); bossDie(); }, 100);
        }, 1000);
        setTimeout(() => { hero.style.opacity = 0; setTimeout(() => { hero.style.left = "-200px"; hero.style.opacity = 1; }, 500); }, 2500);
    }

    // ==========================================
    // 5. å¯¶ç®±èˆ‡å·è»¸ç³»çµ±
    // ==========================================
    function openChest() {
        const chest = document.getElementById('chest-wrapper'); const itemLayer = document.getElementById('item-get-layer');
        if(chest.classList.contains('opened')) return;
        chest.classList.add('opened'); chest.style.animation = "shake 0.5s";
        setTimeout(() => {
            if (itemLayer) itemLayer.style.display = 'flex'; else finishItemGet();
            chest.style.transition = "opacity 0.5s"; chest.style.opacity = 0;
            setTimeout(() => { chest.style.display = 'none'; }, 500);
        }, 800);
    }
    function finishItemGet() {
        const itemLayer = document.getElementById('item-get-layer'); const scrollContent = document.getElementById('scroll-content');
        if(itemLayer) { itemLayer.style.transition = "opacity 0.5s"; itemLayer.style.opacity = 0; setTimeout(() => { itemLayer.style.display = 'none'; }, 500); }
        if(scrollContent) { setTimeout(() => { scrollContent.style.display = 'flex'; scrollContent.style.animation = "floatUp 1s ease-out"; }, 500); }
    }
    
    // å·è»¸ç¢ºèªè¦–çª—èˆ‡ç‡ƒç‡’ç‰¹æ•ˆ
    let rejectCount = 0;
    function askToStart() {
        const modal = document.getElementById('scroll-confirm-modal');
        modal.style.display = 'flex'; setTimeout(() => { modal.style.opacity = 1; modal.classList.add('active'); }, 10);
        const clickSound = document.getElementById('se-click'); if(clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
    }
    function confirmStart(isYes) {
        const modal = document.getElementById('scroll-confirm-modal');
        const clickSound = document.getElementById('se-click'); if(clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
        if (isYes) {
            modal.style.display = 'none'; modal.classList.remove('active');
            const scrollIcon = document.getElementById('scroll-icon'); const startBtn = document.getElementById('start-btn'); const scrollContent = document.getElementById('scroll-content');
            if(startBtn) { startBtn.style.opacity = 0; startBtn.style.pointerEvents = 'none'; }
            if (scrollIcon) { scrollIcon.classList.remove('scroll-burn'); void scrollIcon.offsetWidth; scrollIcon.classList.add('scroll-burn'); }
            setTimeout(() => { spawnFireParticles(); }, 500);
            setTimeout(() => { if(scrollContent) scrollContent.style.display = 'none'; startVortexTransition(); }, 5000); 
        } else {
            rejectCount++; const noBtn = document.getElementById('btn-no');
            if (rejectCount === 1) { alert("âš ï¸ ç³»çµ±è­¦å‘Šï¼šå›æ†¶èƒ½é‡éå¼·ï¼Œç„¡æ³•å–æ¶ˆï¼"); noBtn.innerText = "çœŸçš„ä¸è¦å—ï¼Ÿ"; noBtn.style.color = "#fff"; } 
            else if (rejectCount === 2) { alert("ğŸš« éŒ¯èª¤ï¼šæ‹’çµ•ç„¡æ•ˆã€‚å‘½é‹çš„é½’è¼ªå·²ç¶“é–‹å§‹è½‰å‹•..."); noBtn.innerText = "å¥½å•¦... (Yes)"; noBtn.style.background = "#00f0ff"; noBtn.style.color = "#000"; noBtn.style.boxShadow = "0 0 10px #00f0ff"; noBtn.onclick = function() { confirmStart(true); }; }
        }
    }
    function spawnFireParticles() {
        const scrollIcon = document.getElementById('scroll-icon'); if(!scrollIcon) return;
        const rect = scrollIcon.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
        for(let i=0; i<50; i++) {
            setTimeout(() => {
                const ember = document.createElement('div'); ember.className = 'ember-particle'; document.body.appendChild(ember);
                ember.style.left = centerX + 'px'; ember.style.top = centerY + 'px'; 
                const angle = Math.random() * Math.PI * 2; const dist = 50 + Math.random() * 100;
                ember.style.setProperty('--tx', (Math.cos(angle) * dist) + 'px'); ember.style.setProperty('--ty', (Math.sin(angle) * dist - 50) + 'px');
                const rand = Math.random(); ember.style.backgroundColor = rand > 0.6 ? '#ff4500' : rand > 0.3 ? '#ff8800' : '#555';
                setTimeout(() => ember.remove(), 2000);
            }, i * 40);
        }
    }

    // ==========================================
    // 6. æ™‚å…‰éš§é“éå ´ (Transition)
    // ==========================================
    let vortexId, tunnelRings = [], speedLines = [], memoryFragments = [], vortexStartTime = 0;
    let loadedFragmentImages = [];
    const VORTEX_DURATION = 8000;

    function preloadFragments() {
        const indices = []; while(indices.length < 10) { const r = Math.floor(Math.random() * photoData.length); if(indices.indexOf(r) === -1) indices.push(r); }
        indices.forEach(i => { const img = new Image(); img.src = photoData[i].src; loadedFragmentImages.push(img); });
    }
    preloadFragments();

    function startVortexTransition() {
        const warpSound = document.getElementById('se-warp'); if (warpSound) { warpSound.currentTime = 0; warpSound.volume = 0.8; warpSound.play().catch(console.error); }
        switchMusic('bgm-countdown'); 
        const statusMsg = document.getElementById('status-message'); statusMsg.innerText = "æ­£åœ¨ç©¿è¶Šæ™‚ç©ºè£‚ç¸«..."; statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
        initCanvas(); 
        tunnelRings = []; speedLines = []; memoryFragments = []; vortexStartTime = Date.now();
        for(let i=0; i<15; i++) tunnelRings.push({ z: i * 200, rotation: i * 0.1, color: i % 2 === 0 ? '#00f0ff' : '#ffffff' });
        for(let i=0; i<30; i++) speedLines.push({ angle: Math.random() * Math.PI * 2, length: Math.random() * 200 + 100, speed: Math.random() * 10 + 20, dist: Math.random() * 500 + 200 });
        animateVortex();
        setTimeout(() => { finishVortexAndStart(); }, VORTEX_DURATION);
    }

    function animateVortex() {
        const now = Date.now(); const elapsed = now - vortexStartTime; const progress = Math.min(elapsed / VORTEX_DURATION, 1);
        pCtx.fillStyle = `rgba(5, 5, 10, 0.3)`; pCtx.fillRect(0, 0, pW, pH);
        const cx = pW / 2; const cy = pH / 2; const fov = 600;

        pCtx.lineWidth = 3;
        tunnelRings.forEach(ring => {
            ring.z -= 15 + (progress * 30); ring.rotation += 0.02;
            if(ring.z < -fov) { ring.z += 3000; ring.color = Math.random() > 0.5 ? '#00f0ff' : '#ffd700'; }
            const scale = fov / (fov + ring.z); const size = 600 * scale;
            if (size > 0) {
                pCtx.strokeStyle = ring.color; pCtx.globalAlpha = Math.min(1, scale * 2); pCtx.beginPath();
                for (let i = 0; i <= 8; i++) { const theta = (i / 8) * Math.PI * 2 + ring.rotation; i === 0 ? pCtx.moveTo(cx + Math.cos(theta) * size, cy + Math.sin(theta) * size) : pCtx.lineTo(cx + Math.cos(theta) * size, cy + Math.sin(theta) * size); }
                pCtx.closePath(); pCtx.stroke();
            }
        });
        pCtx.globalAlpha = 1;

        pCtx.strokeStyle = '#ffffff'; pCtx.lineWidth = 2; pCtx.beginPath();
        speedLines.forEach(line => {
            line.dist -= line.speed + (progress * 20); if(line.dist < 50) { line.dist = Math.max(pW, pH); line.angle = Math.random() * Math.PI * 2; }
            const x1 = cx + Math.cos(line.angle) * line.dist; const y1 = cy + Math.sin(line.angle) * line.dist;
            const x2 = cx + Math.cos(line.angle) * (line.dist + line.length); const y2 = cy + Math.sin(line.angle) * (line.dist + line.length);
            pCtx.moveTo(x1, y1); pCtx.lineTo(x2, y2);
        });
        pCtx.stroke();

        if (elapsed % 10 < 2) { 
            pCtx.fillStyle = 'rgba(0, 240, 255, 0.3)'; pCtx.font = 'bold 100px monospace'; pCtx.textAlign = 'center';
            pCtx.fillText(1990 + Math.floor(Math.random() * 35), Math.random() * pW, Math.random() * pH);
        }

        if (elapsed > 1000 && elapsed < VORTEX_DURATION - 1000 && Math.random() > 0.94) {
            const img = loadedFragmentImages[Math.floor(Math.random() * loadedFragmentImages.length)];
            if (img) memoryFragments.push({ img: img, z: 2000, rotation: Math.random() * Math.PI * 2, rotSpeed: (Math.random() - 0.5) * 0.1, opacity: 0 });
        }
        for(let i = memoryFragments.length - 1; i >= 0; i--) {
            let f = memoryFragments[i]; f.z -= 25 + (progress * 20); f.rotation += f.rotSpeed;
            const scale = fov / (fov + f.z); f.opacity = Math.min(1, scale);
            if (f.z < -fov + 100) { memoryFragments.splice(i, 1); continue; }
            pCtx.save(); pCtx.translate(cx, cy); pCtx.scale(scale, scale); 
            const flyOffset = (2000 - f.z) * 0.5; pCtx.translate(Math.cos(f.rotation)*flyOffset, Math.sin(f.rotation)*flyOffset); pCtx.rotate(f.rotation); pCtx.globalAlpha = f.opacity;
            pCtx.fillStyle = '#fff'; pCtx.shadowBlur = 10; pCtx.shadowColor = 'rgba(255, 255, 255, 0.5)'; pCtx.fillRect(-100, -80, 200, 190);
            try { pCtx.drawImage(f.img, -90, -70, 180, 150); } catch(e){} pCtx.restore();
        }

        if (Math.random() > 0.95) {
            const sliceH = Math.random() * 50 + 20; const sliceY = Math.random() * pH; const offset = (Math.random() - 0.5) * 30;
            try { const slice = pCtx.getImageData(0, sliceY, pW, sliceH); pCtx.putImageData(slice, offset, sliceY); } catch(e) {} 
            pCtx.fillStyle = Math.random() > 0.5 ? 'rgba(255,0,0,0.1)' : 'rgba(0,255,255,0.1)'; pCtx.fillRect(0, sliceY, pW, sliceH);
        }

        if (elapsed > VORTEX_DURATION - 1000) { pCtx.fillStyle = `rgba(255, 255, 255, ${(elapsed - (VORTEX_DURATION - 1000)) / 1000})`; pCtx.fillRect(0, 0, pW, pH); }
        vortexId = requestAnimationFrame(animateVortex);
    }

    function finishVortexAndStart() {
        cancelAnimationFrame(vortexId);
        const flash = document.getElementById('flash-overlay'); const intro = document.getElementById('intro-layer'); const statusMsg = document.getElementById('status-message'); const scrollContent = document.getElementById('scroll-content');
        if(scrollContent) scrollContent.style.display = 'none';
        statusMsg.innerText = "æ™‚ç©ºåŒæ­¥å®Œæˆ"; flash.style.opacity = 1; switchMusic(null);
        setTimeout(() => {
            intro.style.transition = "opacity 1.5s"; intro.style.opacity = 0; flash.style.transition = "opacity 2.5s"; flash.style.opacity = 0;
            setTimeout(() => { 
                intro.style.display = 'none'; if(typeof initGalaxy === 'function') initGalaxy(); 
                const ctrl = document.getElementById('control-panel'); if(ctrl) ctrl.classList.add('show');
                setTimeout(() => { const nextBtn = document.getElementById('next-btn'); if(nextBtn) { console.log("ğŸš€ è‡ªå‹•å•Ÿå‹•æ˜Ÿéš›æ—…ç¨‹ï¼"); nextBtn.click(); } }, 800);
            }, 1500);
        }, 500);
    }

    // ==========================================
    // 7. Galaxy ç³»çµ± (æ ¸å¿ƒå±•ç¤º)
    // ==========================================
    function initGalaxy() {
        const totalHeight = photoData.length * STAR_GAP + SCREEN_H; universe.style.height = totalHeight + 'px'; canvas.width = window.innerWidth; canvas.height = totalHeight;
        photoData.forEach((data, i) => {
            const x = window.innerWidth / 2 + Math.sin(i * 1.0) * (window.innerWidth * 0.3); const y = window.innerHeight * 0.5 + i * STAR_GAP;
            starPositions.push({ x, y, data, id: i });
            const el = document.createElement('div'); el.className = 'star-node'; el.style.left = x + 'px'; el.style.top = y + 'px'; el.id = `star-${i}`;
            const core = document.createElement('div'); core.className = 'star-core'; el.appendChild(core);
            const ring = document.createElement('div'); ring.className = 'star-ring'; el.appendChild(ring);
            container.appendChild(el);
        });
        drawStaticPath(); updateCamera(-1);
    }

    // æ–°ç‰ˆå…‰é€Ÿè½‰å ´é‚è¼¯ (é€Ÿåº¦ä¿®æ­£ç‰ˆ)
    async function nextStep() {
        if(isAnimating) return;
        if (currentIndex === -1) switchMusic('bgm-galaxy');
        isAnimating = true;

        // èˆŠç…§ç‰‡é€€å ´
        if(currentIndex >= 0) {
            messageCard.classList.remove('show'); typeText.innerHTML = ""; photoViewer.classList.remove('move-left', 'center-stage');
            const oldStar = document.getElementById(`star-${currentIndex}`);
            if(oldStar) {
                const rect = oldStar.getBoundingClientRect();
                photoViewer.style.top = (rect.top + rect.height/2 - 25) + 'px'; photoViewer.style.left = (rect.left + rect.width/2 - 25) + 'px';
            }
            photoViewer.style.width = '50px'; photoViewer.style.height = '50px';
            await wait(800); photoViewer.style.opacity = 0;
            if(oldStar) { oldStar.classList.remove('hidden'); oldStar.style.transform = "scale(1.5)"; setTimeout(() => oldStar.style.transform = "scale(1)", 300); }
        }

        const nextIndex = currentIndex + 1;
        if(nextIndex >= photoData.length) {
            const nextBtn = document.getElementById('next-btn'); if(nextBtn) { nextBtn.innerText = "âš ï¸ èƒ½é‡è¶…è¼‰..."; nextBtn.style.background = "#ff3333"; }
            const statusMsg = document.getElementById('status-message'); statusMsg.innerText = "âš ï¸ åµæ¸¬åˆ°å¼·å¤§å£½æ˜Ÿèƒ½é‡ âš ï¸\nç©ºé–“å‚³é€å•Ÿå‹•ä¸­..."; statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
            document.getElementById('flash-overlay').style.opacity = 1;      
            setTimeout(() => { window.location.href = "test2.html"; }, 2500); isAnimating = false; return;
        }

        // å…‰é€Ÿé£›è¡Œ
        document.body.classList.add('warp-mode');
        if(nextBtn) nextBtn.innerText = "ğŸš€ å…‰é€Ÿé£›è¡Œä¸­...";
        updateCamera(nextIndex);

        if(nextIndex > 0) {
            const prevPos = starPositions[nextIndex-1]; const nextPos = starPositions[nextIndex];
            await new Promise(resolve => {
                let start = null; 
                // ğŸ”¥ ä¿®æ”¹é‡é»ï¼šé£›è¡Œæ™‚é–“å»¶é•·è‡³ 3000ms (3ç§’)
                const duration = 3000; 
                function step(timestamp) {
                    if (!start) start = timestamp; let p = (timestamp - start) / duration;
                    let easeP = p * p * (3 - 2 * p); if (p > 1) { p = 1; easeP = 1; }
                    drawComet(prevPos, nextPos, easeP);
                    if (p < 1) requestAnimationFrame(step); else resolve();
                }
                requestAnimationFrame(step);
            });
        } else { await wait(1000); }

        document.body.classList.remove('warp-mode');
        
        // æ–°ç…§ç‰‡å±•é–‹
        const nextStar = document.getElementById(`star-${nextIndex}`); const data = photoData[nextIndex];
        if(nextStar) {
            nextStar.classList.add('hidden'); const rect = nextStar.getBoundingClientRect();
            photoViewer.style.transition = 'none'; photoViewer.style.opacity = 1;
            photoViewer.style.top = rect.top + 'px'; photoViewer.style.left = rect.left + 'px'; photoViewer.style.width = '0px'; photoViewer.style.height = '0px';
            if (data.src) photoViewer.style.backgroundImage = `url('${data.src}')`;
            void photoViewer.offsetWidth;
            photoViewer.style.transition = 'all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; photoViewer.classList.add('center-stage');
            // ç‰¹æ•ˆ
            photoViewer.classList.remove('glitch-effect', 'floating-effect');
            setTimeout(() => { photoViewer.classList.add('glitch-effect'); setTimeout(() => { photoViewer.classList.remove('glitch-effect'); if(!photoViewer.classList.contains('move-left')) photoViewer.classList.add('floating-effect'); }, 400); }, 800);
        }

        await wait(1500);
        photoViewer.classList.remove('floating-effect'); photoViewer.classList.add('move-left');
        await wait(500); messageCard.classList.add('show'); await typeWriterEffect(data.text);
        progressBar.style.width = ((nextIndex + 1) / photoData.length * 100) + "%"; currentIndex = nextIndex; isAnimating = false;
        if(nextBtn) { nextBtn.innerText = "ğŸ‘‡ ä¸‹ä¸€å¼µ"; nextBtn.style.opacity = 1; }
    }

    async function typeWriterEffect(text) {
        typeText.innerHTML = '<span class="cursor"></span>'; 
        const typingSound = document.getElementById('bgm-typing');
        if (typingSound) { try { typingSound.currentTime = 0; typingSound.volume = 0.3; await typingSound.play(); } catch (e) {} }
        for (let i = 0; i < text.length; i++) {
            const char = text.charAt(i); const cursor = typeText.querySelector('.cursor'); const span = document.createElement('span');
            span.innerText = char; typeText.insertBefore(span, cursor);
            // ğŸ”¥ ä¿®æ”¹é‡é»ï¼šæ¯å€‹å­—å‡ºç¾é€Ÿåº¦è®Šæ…¢ (å¹³å‡ 0.25ç§’)
            await wait(Math.random() * 150 + 150); 
        }
        if (typingSound) { typingSound.pause(); typingSound.currentTime = 0; }
    }

    function updateCamera(targetIndex) {
        if(targetIndex < 0) targetIndex = 0; const targetY = starPositions[targetIndex].y; const offset = targetY - (window.innerHeight / 2);
        universe.style.transform = `translateY(-${offset}px)`;
    }

    function drawStaticPath() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.beginPath(); ctx.strokeStyle = "rgba(255, 255, 255, 0.1)"; ctx.lineWidth = 1; ctx.setLineDash([5, 15]); 
        if(starPositions.length > 0) {
            ctx.moveTo(starPositions[0].x, starPositions[0].y);
            for(let i=1; i<starPositions.length; i++) { const prev = starPositions[i-1]; const curr = starPositions[i]; ctx.bezierCurveTo(prev.x, (prev.y+curr.y)/2, curr.x, (prev.y+curr.y)/2, curr.x, curr.y); }
        }
        ctx.stroke();
    }

    function drawComet(p1, p2, progress) {
        ctx.clearRect(0, 0, canvas.width, canvas.height); drawStaticPath(); 
        const currentX = p1.x + (p2.x - p1.x) * progress; const currentY = p1.y + (p2.y - p1.y) * progress;
        const gradient = ctx.createLinearGradient(p1.x, p1.y, currentX, currentY);
        gradient.addColorStop(0, "rgba(0, 240, 255, 0)"); gradient.addColorStop(0.8, "rgba(0, 240, 255, 0.8)"); gradient.addColorStop(1, "rgba(255, 255, 255, 1)");
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(currentX, currentY); ctx.strokeStyle = gradient; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.stroke();
        ctx.beginPath(); ctx.arc(currentX, currentY, 6, 0, Math.PI * 2); ctx.fillStyle = "#fff"; ctx.shadowBlur = 20; ctx.shadowColor = "#00f0ff"; ctx.fill(); ctx.shadowBlur = 0;
    }

    function initBackgroundStars() {
        const bgLayer = document.getElementById('bg-layer'); const starCount = 100; 
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div'); const sizeRandom = Math.random();
            star.classList.add('bg-star', sizeRandom > 0.9 ? 'large' : sizeRandom > 0.6 ? 'medium' : 'small');
            star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
            star.style.setProperty('--duration', (2 + Math.random() * 3) + 's'); star.style.animationDelay = (Math.random() * 5) + 's';
            bgLayer.appendChild(star);
        }
    }
    initBackgroundStars();
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    // æ³¨å…¥éœ‡å‹•å‹•ç•«æ¨£å¼ (å‚™ç”¨)
    const shakeStyle = document.createElement("style");
    shakeStyle.innerText = `@keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }`;
    document.head.appendChild(shakeStyle);

</script>
</body>
</html>
